---
title: "Report on Lake Ontario Microbes"
author: "Morrow Zhang"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages 

First, we need to ensure we have access to the functions that we need for our analysis. 
```{r load-packages}
library(tidyverse)

```


# Goal of this Report
Here, I create an analysis of environmental and microbial data from Lake Ontario. The goal is to determnine how environmental variables like temperature affect the aundance of different Phyla of bacteria

# Read in the Data

We need two files: 1) The Taxon File (cleaned up): 2) The Sample Data 

## 1) Taxonomy Data 
```{r load-data}
# Load the taxon abundance data 
taxon_dirty_df <- read_csv("data/taxon_abundance.csv", skip =2) %>% 
  select(-...10) %>%
  rename(sequencer = ...9)
# Look at the top of the dataframe 
head(taxon_dirty_df) 
#View(taxon_dirty_df)

# Clean up data by removing columns
taxon_clean_df <- 
  taxon_dirty_df %>%
  select(sample_id:Cyanobacteria) 

# How many columns? Intuition Check
ncol(taxon_clean_df)
ncol(taxon_dirty_df)

```

## 2) Environmental Data 

Let's load the second data set 

```{r load-data-samples}
sample_data_df <- 
  read_csv("data/sample_data.csv")

# Quick Look 

head(sample_data_df)


```

# Reshaping the Data 

Create long-formatted data from wide-formatted data. 

```{r reshape data}

taxon_long_df <- 
  taxon_clean_df %>%
  pivot_longer(cols = Proteobacteria:Cyanobacteria, 
               names_to = "Phylum", values_to = "Abundance") 

# Intuition Check 
nrow(taxon_long_df)
nrow(taxon_clean_df)
 
```

## Plot Taxon Data 

```{r plot-taxa}
taxon_long_df %>%
  ggplot(aes(x= sample_id, y = Abundance, fill = Phylum)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90))
```

# Joining The Data 

We will combine taxonomy and environmental data together into one dataframe. 

```{r join-data}

# check the sample_id
sample_data_df$sample_id
taxon_clean_df$sample_id

# Check the length 
length(sample_data_df$sample_id)
length(taxon_clean_df$sample_id)

# Fix the sample names 
taxon_clean_goodSep_df <- taxon_clean_df %>%
  mutate(sample_id = str_replace(sample_id, pattern = "Sep", replacement = "September"))

# Sample names are different 
sample_and_taxon_df <- 
  inner_join(sample_data_df, taxon_clean_goodSep_df, by = "sample_id") 

# Intuition check 
dim(sample_and_taxon_df)

# Write the file 
write_csv(sample_and_taxon_df, file = "data/sample_and_taxon.csv")
```

# Plot Chloroflexi 
```{r plot-chloroflexi}
ggplot(sample_and_taxon_df, 
       aes(x = depth, y = Chloroflexi)) +
  geom_point() + 
  labs(x = "Depth (m)", y = "Chloroflexi (% Abundance)", 
       title = "Strong Association of depth and Chlooroflexi Abundance")  + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 2))



```




